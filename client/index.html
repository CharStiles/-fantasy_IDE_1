<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
    <title>fantasyIDE</title>

    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/lint/lint.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/monokai.min.css">
    <link rel="stylesheet" href="/src/styles/nodes.css" />
    <link rel="stylesheet" href="/src/styles/lint.css" />
    <link rel="stylesheet" href="src/styles/editor.css">

    <!-- CodeMirror JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/clike/clike.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/lint/lint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/lint/javascript-lint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jshint/2.13.5/jshint.min.js"></script>
    
    <!-- GLSL Linting -->
    <script>
      function validator(text, options) {
        var result = [];
        // Use the ShaderManager's last compilation errors if available
        if (window.nodeSystem && window.nodeSystem.shaderManager) {
          var errors = window.nodeSystem.shaderManager.lastCompilationErrors || [];
          if (errors) parseErrors(errors, result);
        }
        return result;
      }
      
      function parseErrors(errors, output) {
        for (var i = 0; i < errors.length; i++) {
          var error = errors[i];
          if (error) {
            if (Number(error.line) <= 0) {
              console.warn("Cannot display error (invalid line " + error.line + ")", error);
              continue;
            }

            var start = error.character - 1, end = start + 1;
            var hint = {
              message: error.message,
              severity: "error",
              from: CodeMirror.Pos(Number(error.line) - 1, start),
              to: CodeMirror.Pos(Number(error.line) - 1, end)
            };
            output.push(hint);
          }
        }
      }
      
      // Register the GLSL linter
      CodeMirror.registerHelper("lint", "x-shader/x-fragment", validator);
      CodeMirror.registerHelper("lint", "x-shader/x-vertex", validator);
    </script>
    
    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
  </head>
  <body>
    <div id="node-container">
      <div id="editor"></div>
      <svg id="connections"></svg>
    </div>
    
    <!-- Add defaultShaders.js as a module -->
    <script type="module" src="/src/lib/defaultShaders.js"></script>
    
    <!-- Add main.js to initialize the NodeSystem -->
    <script type="module" src="src/main.js"></script>
  </body>
</html>